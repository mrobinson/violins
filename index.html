<!DOCTYPE html>

<html>
    <head>
         <link rel="stylesheet" href="style.css" />
         <script type="text/javascript" src="raphael-min.js"></script>
         <script type="text/javascript" src="g.raphael-min.js"></script>
         <script type="text/javascript" src="g.bar-min.js"></script>
         <script type="text/javascript" src="data.js"></script>

         <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
         <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
         <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.1.3"></script>
    </head>

    <body>
        <div id="menu">
            <div id="#sexchart" style="width: 200px; height 200px;"></div>
            <div id="#injurychart" style="width: 200px; height 200px;"></div>
            <div id="#agechart" style="width: 200px; height 200px;"></div>
        </div>
        <div id="toggles">
            <div class="button-bar" style="margin-right: 10px;">
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">2008</button>
               </label>
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">2009</button>
               </label>
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">2010</button>
               </label>
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">2011</button>
               </label>
               <label class="button-bar-item">
                   <input type="checkbox"><button class="button-bar-button">2012</button>
               </label>
            </div>

            <div class="button-bar">
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">Bike</button>
               </label>
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">Pedestrian</button>
               </label>
            </div>

            <div class="button-bar">
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">Female</button>
               </label>
               <label class="button-bar-item">
                 <input type="checkbox"><button class="button-bar-button">Male</button>
               </label>
            </div>
        </div>
        <div id="map"></div>
    </body>

    <script>
        var ALL_YEARS = [2008, 2009, 2010, 2011, 2012];
        var ALL_SEXES = ["M", "F"];
        var ALL_TYPES = ["bike", "pedestrian"];

        if (!Array.prototype.indexOf) {
    Array.prototype.indexOf = function (searchElement, fromIndex) {
      if ( this === undefined || this === null ) {
        throw new TypeError( '"this" is null or not defined' );
      }

      var length = this.length >>> 0; // Hack to convert object.length to a UInt32

      fromIndex = +fromIndex || 0;

      if (Math.abs(fromIndex) === Infinity) {
        fromIndex = 0;
      }

      if (fromIndex < 0) {
        fromIndex += length;
        if (fromIndex < 0) {
          fromIndex = 0;
        }
      }

      for (;fromIndex < length; fromIndex++) {
        if (this[fromIndex] === searchElement) {
          return fromIndex;
        }
      }

      return -1;
    };
  }
        function Collision(jsonCollision) {
            var self = this;
            this.year = jsonCollision.year;
            this.sex = jsonCollision.sex;
            this.type = jsonCollision.type;
            this.victims = jsonCollision.victims;
            this.location = jsonCollision.location;

            this.countVictims = function(test) {
                var count = 0;
                for (var v = 0; v < self.victims.length; v++) {
                    if (test(self.victims[v])) {
                        count++;
                    }
                }
                return count;
            }

            this.numberOfFatalities = function() {
                return self.countVictims(function(victim) { return victim.injury === 1; });
            }

            this.numberOfSevereInjuries = function() {
                return self.countVictims(function(victim) { return victim.injury === 2; });
            }
        }

        function CollisionStatistics(collisions) {
            var self = this;
            this.victimInjuries = [0, 0, 0, 0, 0];
            this.victimSexes = [0, 0, 0];
            this.victimAges = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            this.collisionYears = {};
            this.yearsSeen = [];

            this.processCollision = function(collision) {
                if (self.yearsSeen.indexOf(collision.year) == -1) {
                    self.yearsSeen.push(collision.year);
                    self.collisionYears[collision.year] = 0;
                }
                self.collisionYears[collision.year]++;
                for (var v = 0; v < collision.victims.length; v++) {
                    self.processVictim(collision.victims[v]);
                }
            }

            this.processVictim = function(victim) {
                if (victim.sex == "F") {
                    self.victimSexes[0]++;
                } else if (victim.sex == "M") {
                    self.victimSexes[1]++;
                } else {
                    self.victimSexes[2]++;
                }

                self.victimInjuries[victim.injury]++;

                 // Sometimes ages are unspecified by way of very large values.
                if (victim.age >= 0 && victim.age < 150) {
                    var ageGroup = Math.min(Math.floor(victim.age/10), self.victimAges.length - 1);
                    self.victimAges[ageGroup]++;
                }
            }

            for (var i = 0; i < collisions.length; i++) {
                this.processCollision(collisions[i]);
            }

        }

        function addData(data) {
            if (Collision.collisions === undefined) {
                Collision.collisions = [];
            }

            for (var i = 0; i < data.length; i++) {
                Collision.collisions.push(new Collision(data[i]));
            }
        }

        function filterData(years, sexes, types) {
            var results = [];
            for (var i = 0; i < Collision.collisions.length; i++) {
                var collision = Collision.collisions[i];
                if (years.indexOf(collision.year) == -1)
                    continue;
                if (types.indexOf(collision.type) == -1)
                    continue;

                var foundSex = false;
                for (var v = 0; v < collision.victims.length; v++) {
                    if (sexes.indexOf(collision.victims[v].sex) != -1) {
                        foundSex = true;
                        break;
                    }
                }
                if (!foundSex)
                    continue;

                results.push(collision);
            }
            return results;
        }

        var map = L.map('map').setView([37.8044, -122.2708], 13);
        map.addLayer(new L.StamenTileLayer("toner"));

        addData(data);
        var collisions = filterData(ALL_YEARS, ALL_SEXES, ALL_TYPES);
        for (var i = 0; i < collisions.length; i++) {
            var collision = collisions[i];
            var fatal = collision.numberOfFatalities() > 0;
            var severe = collision.numberOfSevereInjuries() > 0;

            if (fatal) {
                var color = 'red';
            } else if (severe) {
                var color = 'purple';
            } else {
                var color = 'gold';
            }

            var marker = L.circle(collision.location, 20, {
                color: color,
                fillColor: color,
                fillOpacity: 1.0,
                opacity: 1.0,
            }).addTo(map);

            if (!fatal && !severe)
                marker.bringToBack();
        }

        var stats = new CollisionStatistics(collisions);
        var sexChart = Raphael("#sexchart", "200px", "200px");
        var injuryChart = Raphael("#injurychart", "200px", "200px");
        var ageChart = Raphael("#agechart", "200px", "200px");

        sexChart.barchart(0, 0, 200, 100, stats.victimSexes, {})
        injuryChart.barchart(0, 0, 200, 100, stats.victimInjuries, {})
        ageChart.barchart(0, 0, 200, 100, stats.victimAges, {})
    </script>
</html>
